<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styleh.css">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&family=Roboto&display=swap" rel="stylesheet">
    <title>Common library. About</title>
</head>
<body>
    <header>
        <a href="search.html">Search</a>
        <a href="add.html">Add</a>
        <a href="index.html"><img src="logo.png" width="60px" alt="Logo"></a>
        <a href="about.html">About us</a>
        <a href="news.html">News</a>
        <p id="profile">
          <a href="login.html">Login</a>/<a href="register.html">Register</a>
        </p>
      </header>
      <main id="content">
        <div id="jamb">
            <img id="addpic" src='add.jpeg'> 
            <div id="text">
                <p id="slogan">Add the books</p>
                <p id="slogan">You are ready to share </p>
                <p id="slogan">Books that are worth sharing</p>
            </div>
        </div>
        <div class="stickcont">
            <div id="stick">
            </div>
        </div> 

        <div id="search_form_add">
            <h3>Type a title or author of the book to choose the right version and get a full info about the book you'd like to add:
             </h3>
             <form method="GET" id="search">
                <input id="searchInput" name="search"> 
                <button type="submit" onclick="searchGoogle(event)">Search a book</button>
              </form>
        <div id="bookFormDiv">
        </div>
        <div id="googleBooks">
        </div>

         <form id="bookForm">
          <input name="comment"> 
            <select name="age">
                <option>Select the age</option>
                <option>0-1</option>
                <option>1-2</option>
                <option>2-6</option>
                <option>6-12</option>
                <option>12-16</option>
                <option>Older</option>
            </select>
            <button type="submit" id="sendbook"> Add book </button>
        </form> </div>
            <div id="googleBooks">
            </div>
           
    </main>
<script>
let urls = {
	createUser:        'http://127.0.0.1:8000/api/v1/auth/users/',
	loginUser:         'http://127.0.0.1:8000/api/v1/auth/token/login/',
	logoutUser:        'http://127.0.0.1:8000/api/v1/auth/token/logout/',
	getAllBooks:       'http://127.0.0.1:8000/api/v1/book/',
	addBook:           'http://127.0.0.1:8000/api/v1/book/',
	getAllAgeRange:    'http://127.0.0.1:8000/api/v1/age/',
	searchByGoogleID:  'http://127.0.0.1:8000/api/v1/ggl/',
}

async function requestGET(url, options={}){
	const param = new URLSearchParams();
	for (p in options){
		param.append(p,options[p])
	}
	console.log('GET запрос:', url + '?' + param);
	try {
		res= await fetch(url + '?' + param);
		console.log(res);
		if (!res.ok){
			return("Error in Get Request(dima)");
		} else {
			let res_Js = res.json();
			return res_Js;
		}
	} catch (error) {
		
	}
}
// get versions from google
let books = []
async function getDataFromAPI(str_q){
	try{
		let charecter = await fetch(str_q);
		let charecter_ob = await charecter.json();
		return charecter_ob;
	}catch{
		console.log('Error');
	}
}
  
// Get books with image
async function search40books(search){
	let setOfBookObjects=[];
	let lengthOfSet = 20;
	let googlePosition = 0;
	let googleStep = 40;
	let q = search.split(' ').join('+');
	console.log(q);
	do {
		let str_q = 'https://www.googleapis.com/books/v1/volumes?q=' + q;
		str_q+= `&startIndex=${googlePosition}`;
		str_q+= `&maxResults=${googleStep}`;

		let response = await getDataFromAPI(str_q)
    
		for (i of response.items){
			if (setOfBookObjects.length < lengthOfSet){
				try {
					setOfBookObjects.push({
					title:i.volumeInfo.title,
					author:i.volumeInfo.authors.join(', '),
					age_range:'???',
					img:i.volumeInfo.imageLinks.thumbnail,
					googl_id:i.id
				})
				} catch (error) {
					continue;
				}
			} else{
				break
			}
		}
		googlePosition += googleStep;
	} while (setOfBookObjects.length < lengthOfSet)
	return setOfBookObjects;

}
//search by input
async function searchGoogle(event) {
  event.preventDefault();
  let input = document.querySelector('#searchInput');
  let search = input.value;
  books = await search40books(search); 
  // console.log(books);
  let div = document.querySelector('#googleBooks');
  div.innerHTML = '';
  idDiv = 0;

//show books
books.forEach((item, index) => {
    const { title, author, img } = item;
    let html = `<div class="book" id="book${index}" onclick="selectBook(event, ${index})">
      <h5>${title}</h5>
      <h6>${author}</h6>
      <img src=${img} width='40px'>
    </div>`;

    div.innerHTML += html;
    idDiv++;
                              });
                              }

let selectedBook = null;
// book selection
async function selectBook(event, index) {
  if (selectedBook) {
    selectedBook.classList.remove('selected');
  }
    let bookDiv = event.target.closest('.book');
    bookDiv.classList.add('selected');
    selectedBook = bookDiv;
    let selectedBookObject = books[index]; // Access the book object using the div index

  if (selectedBookObject) {
    // Access the properties from the book object
      let title = selectedBookObject.title;
      let author = selectedBookObject.author;
      let age_range = selectedBookObject.age_range;
      let img = selectedBookObject.img;
      let googl_id=selectedBookObject.googl_id;
      console.log("Selected", title, author, age_range, googl_id)
      searcheByGoogleId(title, author, age_range, googl_id, img)
       }
      }
 
async function searcheByGoogleId(title, author, age_range, googl_id, img){
    let bookNotFound = false;
  	let searcheID = googl_id;
    let listDiv = document.querySelector('#bookFormDiv')
    listDiv.innerHTML=''
    let res = await requestGET(urls.searchByGoogleID  + searcheID);
      if (typeof(res)==='string') {
      
      console.log ("NOOOOOOOOOOOOOOOOOOOOOOOOOOOOO", res);
              let html1 = `<h4 style="padding-left: 10px;"> We don't have this book in the library, please add your book</h4>
              <form id="bookForm">
              <input name="title" value="${title}" readonly>
              <input name="author" value="${author}" readonly>
              <input type="hidden" name="img" value="${img}">
              <input type="hidden" name="googl_id" value="${googl_id}">
              <input type="hidden" name="actual" value="true">
              <input type="select" name="age_range" value="1">
              <input name="comment" placeholder="Comments">
              <button type="submit" id="sendbook">Add book</button>
            </form>`;
            console.log (html1)
listDiv.innerHTML=html1
    }
    else {


    let html=`<h4 style="padding-left: 10px;"> We have such book in the library, but you can add your sample and comment</h4>
    <img src=${res.img} width='90px' style="padding-left: 10px; margin-bottom: 10px">
    <form id="bookForm">
                  <input name="title" value="${res.title}" readonly>
                  <input name="author" value="${res.author}" readonly>
                  <input type="hidden" name="img" value="${res.img}">
                  <input type="hidden" name="googl_id" value="${res.googl_id}">
                  <input type="hidden" name="actual" value="true">
                  <input type="hidden" name="age_range" value="${res.age_range}">
                  <input name="comment" placeholder="Comments">
                  <button type="submit" id="sendbook">Add book</button>
                </form>`;

   listDiv.innerHTML=html
}
  }
   
	// listDiv.textContent='';
	// let ul = document.createElement('ul');
	// for (t in res){
	// 	let li = document.createElement('li');
	// 	li.innerHTML = t +": <b>" + res[t] + '</b>'
	// 	ul.appendChild(li);
	// }
	// listDiv.appendChild(ul);
	// let hr = document.createElement('hr');
	// listDiv.appendChild(hr);



  //    }
    





   let bookFormplace=document.querySelector('#bookFormDiv')




  //   //if request basa: no
  // const titleInput = document.getElementById('title');
  // const authorInput = document.getElementById('author');
  // const idInput = document.getElementById('id');
  // const imgInput = document.getElementById('img');
  
  // // Set the values of the form fields
  // titleInput.value = data.title;
  // authorInput.value = data.author;
  // idInput.value = data.id;
  // imgInput.value = data.img;

  
    // html=`<h5> We don't have this book in the library, please add your book</h5>
    // <form id="bookFormFull">
    //   <h5>${title}</h5>
    //   <h6>${author}</h6>
    //   <img src=${img} width='70px'>
      
    //     <select name="age">
    //             <option>Select the age</option>
    //             <option>0-1</option>
    //             <option>1-2</option>
    //             <option>2-6</option>
    //             <option>6-12</option>
    //             <option>12-16</option>
    //             <option>Older</option>
    //         </select>  
    //   <input name="comment"> 
    //   <button type="submit" id="sendbook"> Add book </button>
    //   </form> </div> `
    //     }




// // Event listener for addform submission
// document.querySelector('#bookForm').addEventListener('submit', function (event) {
//   event.preventDefault();

//   // Get the selected book ID
//   let bookId = selectedBook ? selectedBook.id : null;

//   // Get the selected age
//   let ageSelect = document.querySelector('select[name="age"]');
//   let selectedAge = ageSelect.value;

//   // comment
//   let commentInput = document.querySelector('input[name="comment"]');
//   let comment = commentInput.value;

  
//   if (selectedBook) {
//     let selectedBookObject = books.find((item, index) => index === parseInt(bookId.replace('book', '')));

//     if (selectedBookObject) {
//       // Access the properties from the book object
//       let title = selectedBookObject.title;
//       let author = selectedBookObject.author;
//       let googl_id = selectedBookObject.googl_id
//       let age_range = selectedAge;
//       let img = selectedBookObject.img;
//       let commentText = comment;

//       let added_book={'title': title,
//       'author': author,
//       'age_range':  age_range,
//        'img':  img,
//        'googl_id': googl_id 
//     }
//       console.log('Selected Book Title:', title);
//       console.log('Selected Book Author:', author);
//       console.log('Selected Book Age Range:', age_range);
//       console.log('Selected Book Image:', img);
//       console.log('Selected Book Comment:', commentText);
//       console.log('all book:', added_book);
//     }
//   }

//   // Reset the form values
//   selectedBook = null;
//   bookId = null;
//   ageSelect.value = '';
//   commentInput.value = '';
// });

</script>

</body>
</html>
